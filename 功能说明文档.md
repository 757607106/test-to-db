# Chat-to-DB 功能说明文档

## 项目概述

Chat-to-DB 是一个智能 BI（商业智能）平台，核心功能是 **Text-to-SQL**，即通过自然语言对话的方式查询数据库。系统采用 LangGraph 构建的 AI Agent 架构，支持多轮对话、智能查询规划、数据分析洞察等高级功能。

### 系统架构

- **前端**：
  - **Admin（管理后台）**：React + Ant Design，用于系统配置和管理
  - **Chat（对话界面）**：Next.js + shadcn/ui，用于用户与 AI 进行对话查询
- **后端**：FastAPI + LangGraph，提供 REST API 和 AI Agent 服务
- **数据库**：MySQL（业务数据）、PostgreSQL（状态持久化）、Neo4j（知识图谱）、Milvus（向量检索）

---

## 一、用户认证与多租户

### 1.1 用户注册与登录

**功能描述**：
- 用户可以注册新账号，同时创建新的租户（公司/组织）
- 支持用户名或邮箱登录
- 基于 JWT Token 的认证机制

**适用场景**：
- 企业用户首次使用系统时注册
- 日常登录访问系统
- 跨应用单点登录（Admin → Chat 跳转）

**核心能力**：
- 用户注册时可创建新租户，自动成为租户管理员
- 支持 Session Code 安全跨域传递（Admin 跳转到 Chat）
- 密码修改和用户信息更新

### 1.2 多租户隔离

**功能描述**：
- 租户级别的数据隔离
- 用户只能访问自己租户的资源（数据库连接、配置等）
- 支持租户管理员管理租户内用户

**适用场景**：
- SaaS 多客户部署
- 企业内部多部门/多团队隔离
- 数据安全和权限控制

---

## 二、数据库连接管理

### 2.1 连接配置

**功能描述**：
- 支持添加、编辑、删除数据库连接
- 支持 MySQL、PostgreSQL 等主流数据库
- 连接测试功能，验证配置正确性

**适用场景**：
- 接入企业现有数据库
- 管理多个数据源
- 验证数据库连通性

**核心能力**：
- 连接信息加密存储
- 支持配置测试（保存前验证）
- 自动发现数据库 Schema

### 2.2 Schema 自动发现

**功能描述**：
- 自动扫描数据库表结构
- 发现表、列、主外键关系
- 支持手动补充表/列描述信息

**适用场景**：
- 快速接入新数据库
- 理解复杂数据库结构
- 为 AI 提供 Schema 上下文

---

## 三、Schema 元数据管理

### 3.1 表和列管理

**功能描述**：
- 可视化展示表结构
- 编辑表/列的业务描述
- 设置主键、外键标识

**适用场景**：
- 丰富 Schema 语义信息
- 帮助 AI 理解业务含义
- 文档化数据库结构

### 3.2 表关系管理

**功能描述**：
- 管理表之间的关联关系
- 支持一对一、一对多、多对多关系
- 关系描述和类型定义

**适用场景**：
- 复杂多表查询支持
- 跨表关联的 SQL 生成
- 数据血缘分析

### 3.3 Graph 可视化

**功能描述**：
- 以图形方式展示表关系
- 节点表示表/列，边表示关联关系
- 支持拖拽布局和交互

**适用场景**：
- 快速理解数据库结构
- 发现潜在的数据关系
- 数据建模和设计评审

**技术实现**：
- 数据同步到 Neo4j 图数据库
- 前端使用图可视化库渲染

---

## 四、智能查询（Text-to-SQL）

### 4.1 自然语言查询

**功能描述**：
- 用户输入自然语言问题
- AI 自动生成对应的 SQL 语句
- 执行 SQL 并返回结果

**适用场景**：
- 非技术人员进行数据查询
- 快速探索数据
- 减少 SQL 编写工作量

**核心能力**：
- 理解业务术语和口语化表达
- 自动关联多表查询
- 处理聚合、排序、筛选等复杂需求

### 4.2 多轮对话

**功能描述**：
- 支持连续对话，上下文保持
- 可基于前次查询结果追问
- 会话状态持久化

**适用场景**：
- 渐进式数据探索
- 深入分析某个数据维度
- 复杂查询的分步骤构建

**技术实现**：
- 使用 thread_id 标识会话
- LangGraph Checkpointer 保存状态
- 消息历史管理

### 4.3 查询澄清机制

**功能描述**：
- 当用户问题不明确时，AI 主动提问澄清
- 支持多选、单选等澄清形式
- 用户回答后继续执行

**适用场景**：
- 模糊的业务术语
- 缺少必要筛选条件
- 多种理解方式需确认

**技术实现**：
- LangGraph interrupt 机制
- 澄清问题生成
- Command(resume=...) 恢复执行

### 4.4 数据分析洞察

**功能描述**：
- 对查询结果自动进行分析
- 生成数据洞察和关键发现
- 提供后续探索建议

**适用场景**：
- 快速理解数据含义
- 发现异常和趋势
- 指导进一步分析方向

**核心能力**：
- 统计特征分析
- 趋势识别
- 异常检测
- 推荐后续问题

### 4.5 图表智能推荐

**功能描述**：
- 根据数据特征自动推荐图表类型
- 生成可视化配置
- 支持多种图表类型

**适用场景**：
- 数据可视化展示
- Dashboard 创建
- 报告生成

**支持的图表类型**：
- 折线图（时间趋势）
- 柱状图（分类对比）
- 饼图（占比分析）
- 表格（明细展示）
- 面积图、散点图等

### 4.6 流式响应

**功能描述**：
- SSE（Server-Sent Events）实时推送
- 逐步展示 AI 处理进度
- 支持取消正在执行的查询

**适用场景**：
- 复杂查询的进度反馈
- 提升用户体验
- 长时间查询的中断控制

---

## 五、三级缓存机制

### 5.1 精确缓存

**功能描述**：
- 相同问题直接返回缓存结果
- 基于问题文本精确匹配

**适用场景**：
- 重复查询加速
- 减少 LLM 调用成本

### 5.2 语义缓存

**功能描述**：
- 语义相似的问题复用缓存
- 基于向量相似度匹配

**适用场景**：
- 不同表述的相同问题
- 近似查询场景

### 5.3 会话历史缓存

**功能描述**：
- 同一会话内的查询结果缓存
- 支持快速引用前次结果

**适用场景**：
- 多轮对话效率提升
- 上下文相关查询

---

## 六、智能训练中心（Hybrid QA）

### 6.1 问答对管理

**功能描述**：
- 存储和管理问答对（问题 + SQL）
- 支持增删改查操作
- 标记验证状态

**适用场景**：
- 积累优质查询样本
- 训练和优化 AI 生成质量
- 建立企业知识库

### 6.2 混合检索

**功能描述**：
- 语义相似度 + 结构匹配的混合检索
- 多维度评分（语义、结构、模式、质量）
- 返回最相关的参考 SQL

**适用场景**：
- Few-shot Learning 样本选择
- 相似问题快速查找
- 辅助 SQL 生成

**技术实现**：
- Milvus 向量数据库
- Neo4j 图谱结构
- 多维度综合评分

### 6.3 用户反馈机制

**功能描述**：
- 点赞：将正确的 SQL 存入训练库
- 点踩：记录反馈用于改进
- 自动提取表名和实体

**适用场景**：
- 持续优化 AI 质量
- 收集用户真实反馈
- 构建高质量样本库

---

## 七、Skills 业务领域管理

### 7.1 Skill 创建和配置

**功能描述**：
- 定义业务领域（如：销售分析、库存管理）
- 关联相关的表、指标、规则
- 设置优先级和激活状态

**适用场景**：
- 大型数据库的分域管理
- 针对性优化特定业务场景
- 控制 AI 的上下文范围

**核心能力**：
- 表关联配置
- 业务规则定义
- 常用查询模式设置
- JOIN 规则配置

### 7.2 Progressive Disclosure

**功能描述**：
- 按需加载 Skill 内容
- 仅加载相关的 Schema 信息
- 减少 Prompt 长度

**适用场景**：
- 超大 Schema（数百张表）
- 精准上下文控制
- 性能优化

### 7.3 Skill 路由

**功能描述**：
- 根据用户问题自动匹配最佳 Skill
- 多 Skill 时智能选择
- 零配置兼容（无 Skill 时使用默认模式）

**适用场景**：
- 多业务领域统一入口
- 智能分流查询请求
- 渐进式配置

---

## 八、语义层管理

### 8.1 指标库

**功能描述**：
- 定义业务指标（如：销售额、转化率）
- 配置计算公式和来源表
- 指标分类和标签管理

**适用场景**：
- 统一业务口径
- 复杂计算封装
- 指标文档化

### 8.2 值域映射

**功能描述**：
- 自然语言术语到数据库值的映射
- 如："已完成" → "COMPLETED"
- 支持列级别配置

**适用场景**：
- 处理枚举值翻译
- 业务术语标准化
- 提升查询准确性

### 8.3 字段 Profile 分析

**功能描述**：
- 分析字段的值分布
- 提取高频值和枚举值
- 辅助值域预检索

**适用场景**：
- 自动发现枚举字段
- 优化查询条件生成
- 数据质量检查

---

## 九、LLM 配置管理

### 9.1 模型配置

**功能描述**：
- 配置多个 LLM 提供商
- 支持 Chat 和 Embedding 模型
- API Key 和 Base URL 管理

**适用场景**：
- 使用自有模型或第三方服务
- 多模型切换和备份
- 成本和性能优化

**支持的提供商**：
- OpenAI
- Azure OpenAI
- 通义千问（Qwen/Tongyi）
- DeepSeek
- 其他 OpenAI 兼容接口

### 9.2 连接测试

**功能描述**：
- 保存前测试模型连通性
- 验证 API Key 有效性
- 获取 Embedding 维度信息

---

## 十、智能体配置

### 10.1 自定义智能体

**功能描述**：
- 创建自定义数据分析智能体
- 配置角色描述和 System Prompt
- 绑定 LLM 配置

**适用场景**：
- 定制化分析风格
- 特定领域专家角色
- 差异化服务

### 10.2 Prompt 智能优化

**功能描述**：
- 输入简单描述，自动生成专业 Prompt
- 结构化的角色定义模板
- 一键优化

**适用场景**：
- 快速创建高质量智能体
- 降低 Prompt 工程门槛

---

## 十一、Dashboard 看板

### 11.1 看板管理

**功能描述**：
- 创建和管理数据看板
- 设置看板名称、描述、可见性
- 支持公开/私有/共享模式

**适用场景**：
- 数据汇总展示
- 团队协作分析
- 定期报告

### 11.2 Widget 组件

**功能描述**：
- 在看板中添加多种组件
- 支持图表、表格、洞察等类型
- 自由拖拽布局

**Widget 类型**：
- 图表（折线、柱状、饼图等）
- 数据表格
- 洞察分析卡片
- 预测分析组件

### 11.3 动态刷新

**功能描述**：
- 配置自动刷新间隔
- 手动全局刷新
- 单个 Widget 独立刷新

**适用场景**：
- 实时数据监控
- 大屏展示
- 定时更新场景

### 11.4 AI 洞察分析

**功能描述**：
- 自动分析看板内所有 Widget 数据
- 发现跨组件的关联和趋势
- 生成综合洞察报告

**适用场景**：
- 快速理解全局数据
- 发现隐藏规律
- 辅助决策分析

**核心能力**：
- 多数据源关联分析
- 异常检测
- 趋势预警
- 数据溯源（Lineage）

### 11.5 智能挖掘

**功能描述**：
- AI 推荐可添加的 Widget
- 基于现有数据分析可探索方向
- 一键应用推荐

**适用场景**：
- 看板内容丰富化
- 发现未关注的维度
- 降低配置门槛

---

## 十二、预测分析

### 12.1 时间序列预测

**功能描述**：
- 基于历史数据预测未来趋势
- 支持多种预测方法
- 生成置信区间

**适用场景**：
- 销售预测
- 库存规划
- 趋势分析

**预测方法**：
- 线性回归
- 移动平均
- 指数平滑
- 高级时序模型

### 12.2 预测列自动识别

**功能描述**：
- 自动识别时间类型列
- 自动识别数值类型列
- 提供样本数据预览

---

## 十三、系统配置

### 13.1 SQL 增强配置

**功能描述**：
- 配置 SQL 生成的增强选项
- 启用/禁用特定功能
- 调整生成策略

**配置项**：
- 简化流程开关
- 澄清机制开关
- 缓存策略
- 重试次数

### 13.2 用户管理

**功能描述**：
- 管理租户内用户
- 设置用户角色（管理员/普通用户）
- 激活/停用用户

**适用场景**：
- 团队成员管理
- 权限控制
- 账号安全

---

## 十四、Chat 对话界面

### 14.1 对话交互

**功能描述**：
- 聊天式交互界面
- 实时消息展示
- 支持文件上传（图片、PDF）

### 14.2 数据库选择

**功能描述**：
- 在对话前选择目标数据库
- 多数据库切换
- 自动加载可用连接

### 14.3 智能体选择

**功能描述**：
- 选择使用的分析智能体
- 支持默认模式和自定义智能体
- 实时切换

### 14.4 结果展示

**功能描述**：
- SQL 语句展示
- 数据表格展示
- 图表可视化
- 分析洞察卡片

### 14.5 会话历史

**功能描述**：
- 查看历史对话列表
- 切换不同会话
- 新建对话

### 14.6 反馈机制

**功能描述**：
- 对结果点赞/点踩
- 优质结果存入训练库
- 持续改进 AI 质量

---

## 十五、技术架构特点

### 15.1 Hub-and-Spoke Agent 架构

**架构描述**：
- Supervisor 作为中心枢纽
- 多个专门的 Worker Agent
- 统一调度和结果汇总

**Worker Agents**：
- Schema Agent：获取数据库结构
- SQL Generator：生成 SQL 语句
- SQL Executor：执行 SQL
- Data Analyst：数据分析
- Chart Generator：图表生成
- Error Recovery：错误恢复

### 15.2 查询规划

**功能描述**：
- 分析用户意图
- 分类查询类型
- 生成执行计划
- 支持复杂查询拆解

### 15.3 多步执行

**功能描述**：
- 复杂查询拆分为子任务
- 顺序执行各子任务
- 结果聚合和整合

### 15.4 错误恢复

**功能描述**：
- 自动检测 SQL 错误
- 智能修复和重试
- 支持列名验证
- 最多 3 次重试

### 15.5 可观测性

**功能描述**：
- 请求追踪（trace_id）
- LangSmith 集成
- 性能监控
- 日志记录

---

## 总结

Chat-to-DB 是一个功能完整的智能 BI 平台，主要特点：

1. **智能查询**：通过自然语言进行数据库查询，支持多轮对话
2. **企业级**：多租户隔离、权限控制、安全认证
3. **可扩展**：模块化 Agent 架构，支持自定义智能体
4. **可视化**：Dashboard 看板、图表推荐、数据洞察
5. **自学习**：用户反馈驱动的持续优化

适用于需要让非技术人员便捷访问数据库、进行自助数据分析的企业场景。
