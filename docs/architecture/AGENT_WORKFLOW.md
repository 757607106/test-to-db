# Agent æ ¸å¿ƒé€»è¾‘æµç¨‹å›¾

## ä¸€ã€ä¸»å›¾æµç¨‹ (IntelligentSQLGraph)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            ç”¨æˆ·å‘é€æŸ¥è¯¢                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     1ï¸âƒ£ load_custom_agent èŠ‚ç‚¹                               â”‚
â”‚  - ä»æ¶ˆæ¯ä¸­æå– agent_id                                                    â”‚
â”‚  - å¦‚æœæœ‰ agent_idï¼Œä»æ•°æ®åº“åŠ è½½è‡ªå®šä¹‰åˆ†æä¸“å®¶                                â”‚
â”‚  - æ›¿æ¢é»˜è®¤çš„ chart_generator_agent                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     2ï¸âƒ£ clarification èŠ‚ç‚¹                                   â”‚
â”‚  - æ£€æµ‹ç”¨æˆ·æŸ¥è¯¢æ˜¯å¦æ¨¡ç³Š/æ­§ä¹‰                                                 â”‚
â”‚  - å¦‚æœæ¨¡ç³Š â†’ ç”Ÿæˆæ¾„æ¸…é—®é¢˜ï¼Œç­‰å¾…ç”¨æˆ·å›å¤                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                               â”‚
            éœ€è¦æ¾„æ¸… â–¼                       ä¸éœ€è¦æ¾„æ¸… â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ pending_clarification â”‚         â”‚   ç»§ç»­ä¸‹ä¸€æ­¥          â”‚
    â”‚ = True                â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚        â†“              â”‚                      â”‚
    â”‚      END              â”‚                      â”‚
    â”‚ (ç­‰å¾…ç”¨æˆ·å›å¤)         â”‚                      â–¼
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             3ï¸âƒ£ cache_check èŠ‚ç‚¹              â”‚
â”‚  - L1: ç²¾ç¡®åŒ¹é…ç¼“å­˜ (ç›¸åŒæŸ¥è¯¢+è¿æ¥ID)         â”‚
â”‚       å­˜å‚¨: å†…å­˜ OrderedDict                â”‚
â”‚       å®¹é‡: 1000æ¡, TTL: 1å°æ—¶              â”‚
â”‚  - L2: è¯­ä¹‰åŒ¹é…ç¼“å­˜ (ç›¸ä¼¼åº¦ >= 95%)           â”‚
â”‚       å­˜å‚¨: Milvus å‘é‡æ•°æ®åº“                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                               â”‚
                               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                               â”‚                               â”‚
                       ç¼“å­˜å‘½ä¸­ â–¼                       ç¼“å­˜æœªå‘½ä¸­ â–¼
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚ ç›´æ¥è¿”å›ç¼“å­˜ç»“æœ       â”‚       â”‚  ç»§ç»­åˆ° supervisor    â”‚
               â”‚        â†“              â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚      END              â”‚                    â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â–¼
                                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                        â”‚        4ï¸âƒ£ supervisor èŠ‚ç‚¹           â”‚
                                        â”‚    (åè°ƒ Worker Agents å®Œæˆä»»åŠ¡)     â”‚
                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                        â”‚
                                                        â–¼
                                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                        â”‚       å­˜å‚¨ç»“æœåˆ°ç¼“å­˜                  â”‚
                                        â”‚        â†“                            â”‚
                                        â”‚      END                            â”‚
                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äºŒã€Supervisor å†…éƒ¨æµç¨‹ (Worker Agents åè°ƒ)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Supervisor (LLMå†³ç­–ä¸­å¿ƒ)                             â”‚
â”‚  - æ ¹æ®å½“å‰çŠ¶æ€æ™ºèƒ½é€‰æ‹©ä¸‹ä¸€ä¸ª Worker Agent                                    â”‚
â”‚  - ä¸€æ¬¡åªè°ƒç”¨ä¸€ä¸ª Agentï¼Œä¸å¹¶è¡Œ                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ğŸ” schema_agent                                        â”‚
â”‚  - åˆ†æç”¨æˆ·æŸ¥è¯¢æ„å›¾                                                         â”‚
â”‚  - æ£€ç´¢ç›¸å…³æ•°æ®åº“è¡¨ç»“æ„                                                      â”‚
â”‚  - è·å–å­—æ®µç±»å‹ã€å€¼æ˜ å°„                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      âš™ï¸ sql_generator_agent                                  â”‚
â”‚  - å†…ç½®æ ·æœ¬æ£€ç´¢ï¼ˆå‚è€ƒå†å² QA å¯¹ï¼‰                                             â”‚
â”‚  - æ ¹æ® schema ä¿¡æ¯ç”Ÿæˆé«˜è´¨é‡ SQL                                            â”‚
â”‚  - åŒ…å«æŸ¥è¯¢ä¼˜åŒ–å’Œæ€§èƒ½å»ºè®®                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ğŸš€ sql_executor_agent                                  â”‚
â”‚  - å®‰å…¨æ‰§è¡Œ SQL è¯­å¥                                                        â”‚
â”‚  - æ ¼å¼åŒ–æŸ¥è¯¢ç»“æœ                                                           â”‚
â”‚  - æ€§èƒ½ç›‘æ§                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                               â”‚
               æ‰§è¡ŒæˆåŠŸ â–¼                      æ‰§è¡Œå¤±è´¥ â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  æ£€æŸ¥æ˜¯å¦éœ€è¦å›¾è¡¨å¯è§†åŒ–    â”‚    â”‚  ğŸ”§ error_recovery_agent   â”‚
    â”‚  (ç”¨æˆ·æ„å›¾/æ•°æ®é€‚åˆæ€§)     â”‚    â”‚  - é”™è¯¯æ¨¡å¼è¯†åˆ«            â”‚
    â”‚                           â”‚    â”‚  - æä¾›ä¿®å¤æ–¹æ¡ˆ            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  - æœ€å¤šé‡è¯•ä¸€æ¬¡            â”‚
                â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
        â”‚               â”‚                      â”‚
   éœ€è¦å›¾è¡¨ â–¼      ä¸éœ€è¦ â–¼                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚ ğŸ“Š chart_   â”‚  â”‚    å®Œæˆ     â”‚              â”‚
â”‚ generator_  â”‚  â”‚             â”‚              â”‚
â”‚ agent       â”‚  â”‚             â”‚              â”‚
â”‚ - ç”Ÿæˆå¯è§†åŒ–â”‚  â”‚             â”‚              â”‚
â”‚   å›¾è¡¨é…ç½®  â”‚  â”‚             â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
        â”‚               â”‚                      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                             è¿”å›æœ€ç»ˆç»“æœ                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¸‰ã€çŠ¶æ€æµè½¬ (current_stage)

```
clarification â†’ schema_analysis â†’ sample_retrieval â†’ sql_generation 
                                                          â†“
              completed â† chart_generation â† sql_execution
                             â†‘                     â†“
                             â””â”€â”€â”€â”€ error_recovery â”€â”˜
```

---

## å››ã€å…³é”®è®¾è®¡æ€»ç»“

| å±‚çº§ | ç»„ä»¶ | èŒè´£ |
|------|------|------|
| **ä¸»å›¾** | `IntelligentSQLGraph` | æµç¨‹æ§åˆ¶ã€ç¼“å­˜æ£€æŸ¥ã€æ¾„æ¸…æœºåˆ¶ |
| **åè°ƒå±‚** | `SupervisorAgent` | æ™ºèƒ½è·¯ç”±ã€Agentè°ƒåº¦ |
| **Workerå±‚** | `schema_agent` | æ•°æ®åº“æ¨¡å¼åˆ†æ |
| | `sql_generator_agent` | SQLç”Ÿæˆï¼ˆå«æ ·æœ¬æ£€ç´¢ï¼‰ |
| | `sql_executor_agent` | SQLæ‰§è¡Œ |
| | `chart_generator_agent` | å›¾è¡¨ç”Ÿæˆ |
| | `error_recovery_agent` | é”™è¯¯æ¢å¤ |

**æ ¸å¿ƒç‰¹æ€§ï¼š**
1. **ä¸¤å±‚æ¶æ„**ï¼šä¸»å›¾æ§åˆ¶æµç¨‹ + Supervisoråè°ƒAgent
2. **ç¼“å­˜ä¼˜å…ˆ**ï¼šç²¾ç¡®åŒ¹é… + è¯­ä¹‰åŒ¹é…åŒå±‚ç¼“å­˜
3. **æ¾„æ¸…æœºåˆ¶**ï¼šæ¨¡ç³ŠæŸ¥è¯¢è‡ªåŠ¨è§¦å‘äººæœºäº¤äº’
4. **è‡ªæ„ˆèƒ½åŠ›**ï¼šé”™è¯¯è‡ªåŠ¨æ£€æµ‹å’Œæ¢å¤
5. **å¯æ‰©å±•**ï¼šæ”¯æŒåŠ¨æ€åŠ è½½è‡ªå®šä¹‰åˆ†æä¸“å®¶

---

## äº”ã€ç¼“å­˜ç³»ç»Ÿè¯¦è§£

### ç¼“å­˜æ•°æ®å­˜æ”¾ä½ç½®

#### 1. ç²¾ç¡®åŒ¹é…ç¼“å­˜ (L1)
**å­˜æ”¾ä½ç½®**: **å†…å­˜ä¸­** (`OrderedDict`)
- å®ç°ç±»ï¼š`QueryCacheService` (å•ä¾‹æ¨¡å¼)
- æ•°æ®ç»“æ„ï¼š`OrderedDict[str, CacheEntry]`
- ç¼“å­˜é”®ï¼š`MD5(normalize(query):connection_id)`
- é…ç½®ï¼š
  - æœ€å¤§å®¹é‡ï¼š1000 æ¡
  - TTLï¼š3600 ç§’ï¼ˆ1å°æ—¶ï¼‰
  - æ·˜æ±°ç­–ç•¥ï¼šLRU
  - çº¿ç¨‹å®‰å…¨ï¼šä½¿ç”¨ `Lock`

**CacheEntry ç»“æ„ï¼š**
```python
{
    query: str              # åŸå§‹æŸ¥è¯¢
    connection_id: int      # æ•°æ®åº“è¿æ¥ID
    sql: str                # ç”Ÿæˆçš„SQL
    result: Any             # æ‰§è¡Œç»“æœ
    created_at: float       # åˆ›å»ºæ—¶é—´æˆ³
    hit_count: int          # å‘½ä¸­æ¬¡æ•°
}
```

#### 2. è¯­ä¹‰åŒ¹é…ç¼“å­˜ (L2)
**å­˜æ”¾ä½ç½®**: **Milvus å‘é‡æ•°æ®åº“**
- å®ç°ï¼šå¤ç”¨ç°æœ‰çš„ `HybridRetrievalEnginePool`
- æ•°æ®æ¥æºï¼šå†å² QA æ ·æœ¬ï¼ˆé—®é¢˜-SQLå¯¹ï¼‰
- æ£€ç´¢æ–¹å¼ï¼šå‘é‡è¯­ä¹‰æ£€ç´¢
- é…ç½®ï¼š
  - ç›¸ä¼¼åº¦é˜ˆå€¼ï¼š>= 0.95
  - æ£€ç´¢æ•°é‡ï¼štop_k = 1
  - å­˜å‚¨å†…å®¹ï¼šSQL è¯­å¥ï¼ˆä¸å«æ‰§è¡Œç»“æœï¼‰

**å·¥ä½œæµç¨‹ï¼š**
```
1. ç”¨æˆ·æŸ¥è¯¢ â†’ å‘é‡åŒ– (Embedding)
2. Milvus è¯­ä¹‰æ£€ç´¢ â†’ è¿”å›æœ€ç›¸ä¼¼çš„å†å² QA å¯¹
3. åˆ¤æ–­ç›¸ä¼¼åº¦ >= 0.95 â†’ å‘½ä¸­
4. è¿”å› SQLï¼ˆæ‰§è¡Œç»“æœéœ€ä» L1 æŸ¥æ‰¾æˆ–é‡æ–°æ‰§è¡Œï¼‰
```

### ç¼“å­˜æ£€æŸ¥æµç¨‹

```
cache_check_node æ¥æ”¶æŸ¥è¯¢
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ç²¾ç¡®åŒ¹é…æ£€æŸ¥ (L1)            â”‚
â”‚    _check_exact_cache()        â”‚
â”‚    â†“                           â”‚
â”‚    MD5(query:connection_id)    â”‚
â”‚    â†“                           â”‚
â”‚    å‘½ä¸­ï¼Ÿâ†’ è¿”å› SQL + ç»“æœ      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚ æœªå‘½ä¸­
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. è¯­ä¹‰åŒ¹é…æ£€æŸ¥ (L2)            â”‚
â”‚    _check_semantic_cache()     â”‚
â”‚    â†“                           â”‚
â”‚    Milvus å‘é‡æ£€ç´¢             â”‚
â”‚    â†“                           â”‚
â”‚    ç›¸ä¼¼åº¦ >= 0.95ï¼Ÿ            â”‚
â”‚    â†“                           â”‚
â”‚    å‘½ä¸­ â†’ è¿”å› SQL             â”‚
â”‚    (å¯èƒ½æ— æ‰§è¡Œç»“æœ)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚ æœªå‘½ä¸­
        â†“
   ç»§ç»­ supervisor æµç¨‹
```

### ç¼“å­˜å­˜å‚¨æ—¶æœº

```
supervisor_node æ‰§è¡Œå®Œæˆ
        â†“
_store_result_to_cache()
        â†“
æå–ç”Ÿæˆçš„ SQL å’Œæ‰§è¡Œç»“æœ
        â†“
store_result() â†’ å­˜å…¥ L1 ç¼“å­˜
        â†“
(L2 ç¼“å­˜é€šè¿‡ QA æ ·æœ¬ç®¡ç†ç³»ç»Ÿæ›´æ–°)
```

### ä¼˜åŠ¿åˆ†æ

| å±‚çº§ | ä¼˜åŠ¿ | åŠ£åŠ¿ |
|------|------|------|
| **L1 ç²¾ç¡®ç¼“å­˜** | é€Ÿåº¦æå¿«ï¼ˆå†…å­˜ï¼‰ã€åŒ…å«æ‰§è¡Œç»“æœ | å®¹é‡æœ‰é™ã€è¿›ç¨‹é‡å¯ä¸¢å¤± |
| **L2 è¯­ä¹‰ç¼“å­˜** | æ”¯æŒç›¸ä¼¼é—®é¢˜ã€æŒä¹…åŒ–å­˜å‚¨ | ä»…æœ‰ SQLã€éœ€é‡æ–°æ‰§è¡Œ |

---

## å…­ã€å·²çŸ¥é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### é—®é¢˜1: ç¼“å­˜æ— æ³•å­˜å‚¨æ‰§è¡Œç»“æœ âœ… å·²è§£å†³

**ç°è±¡:**
- ç›¸åŒæŸ¥è¯¢ç¬¬äºŒæ¬¡æ‰§è¡Œä»ç„¶æœªå‘½ä¸­ç¼“å­˜
- æˆ–è€…åªå‘½ä¸­ SQL ä½†æ²¡æœ‰æ‰§è¡Œç»“æœï¼Œéœ€è¦é‡æ–°æ‰§è¡Œ
- æ—¥å¿—æ˜¾ç¤ºï¼š`has_execution_result: false`

**æ ¹æœ¬åŸå› :**
```python
# supervisor_agent.py ç¬¬112è¡Œ
output_mode="full_history"  # åªè¿”å› messagesï¼Œä¸¢å¤± execution_result ç­‰çŠ¶æ€å­—æ®µ
```

`langgraph_supervisor` çš„ `create_supervisor` å‡½æ•°åªæ”¯æŒä¸¤ç§ `output_mode`ï¼š
- `full_history`ï¼šè¿”å›å®Œæ•´æ¶ˆæ¯å†å²
- `last_message`ï¼šåªè¿”å›æœ€åä¸€æ¡æ¶ˆæ¯

**ä¸æ”¯æŒ `state` æ¨¡å¼**ï¼Œå› æ­¤æ— æ³•ç›´æ¥è¿”å› `execution_result` å­—æ®µã€‚

**è§£å†³æ–¹æ¡ˆ:**

ç”±äºæ— æ³•ä¿®æ”¹ supervisor çš„è¿”å›æ¨¡å¼ï¼Œæ”¹ä¸ºä» `ToolMessage` ä¸­æå–æ‰§è¡Œç»“æœï¼š

```python
# chat_graph.py - _store_result_to_cache æ–¹æ³•
# sql_executor_agent å°†æ‰§è¡Œç»“æœå­˜å…¥ ToolMessage.contentï¼ˆJSONæ ¼å¼ï¼‰
for msg in reversed(result_messages):
    if isinstance(msg, ToolMessage) and msg.name == 'execute_sql_query':
        parsed_result = json.loads(msg.content)
        execution_result = {
            "success": parsed_result.get("success"),
            "data": parsed_result.get("data"),
            "error": parsed_result.get("error")
        }
        break
```

**æ•°æ®æµ:**
```
sql_executor_agent æ‰§è¡Œ SQL
        â†“
ç»“æœå­˜å…¥ ToolMessage.content (JSON)
        â†“
supervisor è¿”å› messagesï¼ˆåŒ…å« ToolMessageï¼‰
        â†“
_store_result_to_cache è§£æ ToolMessage.content
        â†“
æå– execution_result å­˜å…¥ L1 ç¼“å­˜
```

**ä¿®å¤æ—¶é—´:** 2026-01-19

**å½±å“:**
- âœ… L1 ç¼“å­˜ç°åœ¨å¯ä»¥æ­£ç¡®å­˜å‚¨æ‰§è¡Œç»“æœ
- âœ… ç›¸åŒæŸ¥è¯¢ç¬¬äºŒæ¬¡ä¼šç›´æ¥è¿”å›ç¼“å­˜ç»“æœï¼Œä¸å†é‡æ–°æ‰§è¡Œ
- âœ… æ˜¾è‘—æå‡é‡å¤æŸ¥è¯¢çš„å“åº”é€Ÿåº¦
