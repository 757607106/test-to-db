# 项目优化实施计划

基于对当前项目的深度分析，结合 LangGraph 官方最佳实践，制定以下分阶段优化计划。本计划旨在解决性能瓶颈、架构冗余及交互体验问题，同时确保**核心业务准确率不降低**反而提升。

## 第一阶段：Chat 服务核心重构 (优先级最高)
**目标**：提升 SQL 生成速度，解决“回复不连贯”问题，增强架构可维护性。

### 1. 重构 SQLGeneratorAgent (LangGraph 标准化)
目前的问题是手动调用工具且 Prompt 过大。我们将改为标准的 LangGraph 节点模式。
- **引入结构化输出 (Structured Output)**：
  - 不再让 LLM 返回纯文本再正则解析。
  - 使用 Pydantic 模型定义输出：
    ```python
    class SQLOutput(BaseModel):
        sql: str = Field(..., description="生成的SQL语句")
        thought_process: str = Field(..., description="生成思路")
        used_tables: List[str] = Field(..., description="使用的表名")
    ```
  - 使用 `llm.with_structured_output(SQLOutput)` 确保 100% 格式正确。
- **实施 Schema RAG (检索增强生成)**：
  - **现状**：将整个数据库 Schema 塞入 Prompt，导致 Token 消耗大、生成慢。
  - **优化**：在 SQL 生成前增加 `SchemaRetrieval` 步骤，仅检索与用户 Query 语义相关的表结构（Top-N）。
  - **预期效果**：Prompt 长度减少 70%+, 生成速度提升 2-3 倍。

### 2. 优化 ParallelIntelligentSQLGraph
- **状态管理升级**：
  - 引入 `MemorySaver` (Checkpointer) 实现真正的会话持久化。
  - 支持 `thread_id`，确保用户上下文（如“上一个问题的结果”）不丢失。
- **清理冗余代码**：
  - 废弃 `chat_graph.py`，将 `parallel_chat_graph.py` 确立为唯一核心链路。
  - 移除手动拼接 `messages` 的逻辑，使用 LangGraph 原生的 `messages` 状态更新机制。

## 第二阶段：Admin 后台性能与交互优化
**目标**：解决“数据挖掘慢”导致的页面卡死，提升图表渲染成功率。

### 1. 异步洞察生成
- **后端改造**：
  - 将 `DashboardInsightService.generate_dashboard_insights` 从同步阻塞改为 **FastAPI BackgroundTasks**。
  - 新增/复用 Widget 的 `refresh_status` 字段，前端通过轮询或 SSE 获取进度。
- **前端交互**：
  - 点击“分析”后立即返回，显示“AI 正在分析中...”骨架屏。
  - 分析完成后自动刷新 Widget 内容。

### 2. 增强图表组件 (SmartChart.tsx)
- **智能降级策略**：
  - 当 `analyzeDataAndGetChartType` 无法识别图表类型或数据格式异常时，**不再返回 null**。
  - 默认降级渲染为 **动态表格 (Table)**，确保用户永远能看到数据。
- **类型识别鲁棒性**：
  - 优化日期列检测逻辑（不仅依赖正则，兼容更多时间格式）。
  - 放宽数据结构要求，支持非标准 JSON 格式的自动适配。

## 第三阶段：LangGraph 架构规范化
**目标**：对齐官方文档，提升代码质量和可扩展性。

### 1. 统一 State 定义
- 规范化 `SQLMessageState`，确保所有 Agent 共享同一套类型安全的 State。
- 移除全局单例 Agent 模式，改为请求级生命周期或依赖注入，避免并发污染。

### 2. 错误处理与可观测性
- 完善 `error_recovery` 节点，针对 SQL 执行错误进行特定的自我修正（Self-Correction）。
- 增加关键节点的 Latency 和 Token Usage 日志。

## 验证计划
在每一步修改后，我们将执行以下验证：
1.  **准确率测试**：使用 benchmark SQL 集合（包含模糊查询、多表连接）进行回归测试，确保 SQL 生成准确率不低于当前水平。
2.  **性能测试**：对比优化前后的 TTFT (Time To First Token) 和总生成时间。
3.  **UI 验收**：手动测试 Admin 后台的分析功能，确保无阻塞、无白屏。

---
**确认请求**：
请确认是否优先开始 **第一阶段（Chat 服务核心重构）**？这将直接解决用户最关心的“生成慢”和“回复不连贯”问题。