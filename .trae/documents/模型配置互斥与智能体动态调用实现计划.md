# 实施计划：模型配置与智能体集成

本计划旨在实现以下三个核心需求：
1. **模型配置管理**：在 Admin 后台配置模型启用状态，并确保同类型模型（Chat/Embedding）互斥启用。
2. **后端动态调用**：后端服务根据配置动态调用已启用的模型。
3. **智能体选择与应用**：在 Chat 界面选择自定义智能体，并在后端处理流程中使用该智能体替代默认的结果分析。

---

## 1. 后端：模型配置互斥逻辑 (Backend - Model Configuration)

**目标**：确保同一种类型（Chat 或 Embedding）的模型只能有一个处于"启用"状态。

- **修改文件**: `backend/app/crud/crud_llm_config.py`
- **操作**:
    - 重写 `create` 和 `update` 方法。
    - 当用户尝试设置某个配置为 `is_active=True` 时，自动将数据库中所有同 `model_type` 的其他配置更新为 `is_active=False`。
    - 保持原子性操作（使用事务）。

## 2. 后端：智能体动态选择与调用 (Backend - Agent Selection)

**目标**：支持前端传递 `agent_id`，并在处理链中激活该智能体进行结果分析。

- **修改文件**: `backend/app/schemas/query.py`
    - 在 `ChatQueryRequest` 模型中添加可选字段 `agent_id: Optional[int] = None`。
- **修改文件**: `backend/app/api/api_v1/endpoints/query.py`
    - 更新 `chat_query` 接口，接收 `agent_id`。
    - 根据 `agent_id` 查询 `AgentProfile`。
    - 将查找到的 `AgentProfile` 传递给 `IntelligentSQLGraph`。
- **修改文件**: `backend/app/agents/chat_graph.py` & `backend/app/agents/agents/supervisor_agent.py`
    - 修改 `IntelligentSQLGraph.process_query` 和 `SupervisorAgent` 的构造函数/方法，以接收 `active_agent_profile`。
    - 在 `SupervisorAgent` 中：
        - 确保选中的智能体被实例化并加入到工作代理列表（如果尚未存在）。
        - **关键逻辑**：动态修改 Supervisor 的 System Prompt。如果存在 `active_agent_profile`，在 Prompt 中明确指令："在 `sql_executor_agent` 执行成功后，必须调用 `{agent_name}` 对数据进行分析"，替代默认的分析逻辑。

## 3. 前端：Chat 界面智能体选择器 (Frontend - Chat UI)

**目标**：允许用户在对话界面选择要使用的智能体。

- **新建文件**: `frontend/chat/src/components/ui/agent-selector.tsx`
    - 创建一个下拉选择组件。
    - 在组件加载时调用 `/api/v1/agent-profiles` (需要确认或新建获取活跃智能体列表的 API) 获取可用智能体。
- **修改文件**: `frontend/chat/src/app/page.tsx` (或相关上下文/Provider)
    - 引入 `AgentSelector` 组件，放置在输入框附近或顶部设置栏。
    - 管理 `selectedAgentId` 状态。
    - 在发送消息时，将 `selectedAgentId` 包含在请求体中发送给后端。

## 4. 前端：Admin 模型配置页面 (Frontend - Admin)

**目标**：完善模型配置页面的交互（如果尚不完善）。

- **检查/修改**: `frontend/admin/src/pages/LLMConfig/index.tsx`
    - 确保启用/禁用开关能够正确调用后端 API，并即时反映互斥逻辑的结果（可能需要重新获取列表以更新其他行的状态）。

## 执行顺序

1.  **Backend Core**: 实现 `CRUDLLMConfig` 的互斥逻辑。
2.  **Backend Schema & API**: 更新 Schema 和 Chat Endpoint 以支持 `agent_id`。
3.  **Backend Agent Logic**: 修改 `SupervisorAgent` 以支持动态智能体注入和 Prompt 调整。
4.  **Frontend Chat**: 实现智能体选择器并联调。
5.  **验证**: 测试模型互斥、测试选择智能体后的对话流程。
