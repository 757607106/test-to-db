# 智能训练中心 - 智能搜索功能使用指南

## 功能概述

智能训练中心的**智能搜索**功能是一个基于混合检索（Hybrid Retrieval）的问答对搜索系统，能够通过自然语言问题快速找到相似的SQL查询示例。

## 功能特点

### 1. 混合检索技术
结合多种检索方法，提供高准确度的搜索结果：
- **语义检索** (60%权重): 使用向量相似度匹配问题的语义含义
- **结构检索** (20%权重): 基于数据库schema和表结构匹配
- **模式检索** (10%权重): 识别SQL查询模式和类型
- **质量评分** (10%权重): 考虑问答对的验证状态和成功率

### 2. 智能评分系统
每个搜索结果包含详细的评分信息：
- **final_score**: 综合得分（0-1之间）
- **semantic_score**: 语义相似度得分
- **structural_score**: 结构匹配得分
- **pattern_score**: 模式匹配得分
- **quality_score**: 质量评分
- **explanation**: 推荐理由说明

### 3. 多维度筛选
- 按数据库连接筛选
- 按查询类型分类（SELECT, JOIN, AGGREGATE, GROUP_BY, ORDER_BY）
- 按难度等级过滤（1-5级）
- 按验证状态筛选

## 使用方法

### 在后台管理界面使用

1. **访问智能训练中心**
   - 登录后台管理系统 (http://localhost:3001)
   - 点击左侧导航栏的"智能训练"
   - 进入"混合检索问答对管理"页面

2. **使用智能搜索**
   - 点击"智能搜索"标签页
   - 在搜索框中输入自然语言问题
   - 选择数据库连接（可选）
   - 设置返回结果数量（1-20，默认5）
   - 点击"搜索"按钮

3. **查看搜索结果**
   - 结果按相关度排序显示
   - 可以查看每个结果的详细信息
   - 可以对结果进行反馈

### 使用API调用

#### 搜索相似问答对

```bash
curl -X POST http://localhost:8000/api/hybrid-qa/qa-pairs/search \
  -H "Content-Type: application/json" \
  -d '{
    "question": "查询产品库存",
    "connection_id": 10,
    "top_k": 5
  }'
```

#### 响应示例

```json
[
  {
    "qa_pair": {
      "id": "qa_abc123",
      "question": "查询所有产品的库存数量",
      "sql": "SELECT product_name, stock_quantity FROM products",
      "connection_id": 10,
      "query_type": "SELECT",
      "difficulty_level": 1,
      "verified": true
    },
    "semantic_score": 0.85,
    "structural_score": 0.75,
    "pattern_score": 0.80,
    "quality_score": 0.90,
    "final_score": 0.82,
    "explanation": "高度语义匹配，已验证的高质量示例"
  }
]
```

## API端点

### 1. 搜索相似问答对
- **端点**: `POST /api/hybrid-qa/qa-pairs/search`
- **请求体**:
  ```json
  {
    "question": "string",           // 必填：自然语言问题
    "connection_id": 10,            // 可选：数据库连接ID
    "schema_context": {},           // 可选：schema上下文信息
    "top_k": 5                      // 可选：返回数量（默认5）
  }
  ```

### 2. 创建问答对
- **端点**: `POST /api/hybrid-qa/qa-pairs/`
- **请求体**:
  ```json
  {
    "question": "string",
    "sql": "string",
    "connection_id": 10,
    "query_type": "SELECT",
    "difficulty_level": 1,
    "verified": true
  }
  ```

### 3. 获取问答对列表
- **端点**: `GET /api/hybrid-qa/qa-pairs/`
- **参数**: `connection_id` (可选), `limit` (默认100)

### 4. 获取统计信息
- **端点**: `GET /api/hybrid-qa/qa-pairs/stats`
- **参数**: `connection_id` (可选)

### 5. 更新问答对
- **端点**: `PUT /api/hybrid-qa/qa-pairs/{qa_id}`

### 6. 删除问答对
- **端点**: `DELETE /api/hybrid-qa/qa-pairs/{qa_id}`

### 7. 提交反馈
- **端点**: `POST /api/hybrid-qa/qa-pairs/feedback`

## 测试验证

### 测试结果示例

使用测试脚本验证功能：

```bash
cd /Users/pusonglin/chat-to-db/backend
python3 test_hybrid_search_with_data.py
```

**测试结果**（2026-01-18）：
- ✅ 创建了11个问答对
- ✅ 智能搜索功能正常
- ✅ 相关度评分准确
- ✅ 支持语义理解

示例搜索结果：
- "查询产品库存" → 匹配到"查询所有产品的库存数量" (得分: 0.560)
- "统计产品数量" → 匹配到"按类别统计产品数量" (得分: 0.593)
- "低库存警报" → 匹配到"查询低库存产品" (得分: 0.524)
- "供应商信息" → 匹配到"查询每个供应商提供的产品数量" (得分: 0.273)

## 配置说明

### 环境变量配置

在 `.env` 文件中配置：

```bash
# Milvus向量数据库
MILVUS_HOST=localhost
MILVUS_PORT=19530

# 向量服务配置
VECTOR_SERVICE_TYPE=aliyun          # 使用阿里云DashScope
DASHSCOPE_API_KEY=your_api_key     # DashScope API密钥
VECTOR_DIMENSION=1024               # 向量维度

# 混合检索配置
HYBRID_RETRIEVAL_ENABLED=true
SEMANTIC_WEIGHT=0.60               # 语义相似度权重
STRUCTURAL_WEIGHT=0.20             # 结构匹配权重
PATTERN_WEIGHT=0.10                # 模式匹配权重
QUALITY_WEIGHT=0.10                # 质量评分权重

# Neo4j图数据库（用于结构检索）
NEO4J_URI=bolt://localhost:7687
NEO4J_USER=neo4j
NEO4J_PASSWORD=your_password
```

### 服务依赖

系统依赖以下服务正常运行：

1. **Milvus** (端口 19530)
   - 向量数据库，用于语义检索
   
2. **Neo4j** (端口 7687)
   - 图数据库，用于结构和模式检索
   
3. **阿里云DashScope**
   - 文本向量化服务

## 技术架构

### 核心组件

1. **HybridRetrievalEngine** (`hybrid_retrieval_service.py`)
   - 混合检索引擎主类
   - 协调多种检索方法
   - 融合和排序结果

2. **MilvusService**
   - 向量数据库服务
   - 存储和检索问答对向量

3. **Neo4jService**
   - 图数据库服务
   - 存储schema和关系信息

4. **FusionRanker**
   - 结果融合和排序
   - 加权评分计算

### 数据流程

```
用户问题
  ↓
[语义向量化]
  ↓
[并行检索]
  ├─ 语义检索 (Milvus)
  ├─ 结构检索 (Neo4j)
  └─ 模式检索 (规则)
  ↓
[融合排序]
  ↓
[返回Top-K结果]
```

## 最佳实践

### 1. 创建高质量问答对
- 使用清晰、具体的自然语言问题
- 确保SQL语句正确可执行
- 标记已验证的问答对
- 设置合适的难度等级

### 2. 优化搜索结果
- 提供完整的schema上下文
- 使用具体的数据库连接ID
- 适当调整top_k参数
- 对搜索结果提供反馈

### 3. 维护问答对库
- 定期验证问答对的正确性
- 删除过时或错误的问答对
- 添加多样化的查询示例
- 覆盖不同难度级别和查询类型

## 问题排查

### 搜索结果为空

**可能原因**:
1. 问答对库为空或数据太少
2. connection_id筛选过严格
3. 向量服务未正常工作

**解决方法**:
1. 检查问答对数量: `GET /api/hybrid-qa/qa-pairs/stats`
2. 尝试不指定connection_id
3. 查看服务日志检查向量化是否成功

### 搜索结果相关度低

**可能原因**:
1. 问答对质量不高
2. 问题描述不够具体
3. schema上下文不完整

**解决方法**:
1. 添加更多高质量的问答对
2. 使用更具体的问题描述
3. 提供完整的schema_context

### 服务启动失败

**可能原因**:
1. Milvus或Neo4j未启动
2. 网络配置问题
3. API密钥配置错误

**解决方法**:
1. 检查依赖服务状态
2. 验证.env配置
3. 查看服务启动日志

## 性能优化

### 并行检索
```bash
PARALLEL_RETRIEVAL=true  # 启用并行检索，提升速度
```

### 向量缓存
```bash
VECTOR_CACHE_ENABLED=true  # 启用向量缓存
VECTOR_CACHE_TTL=3600      # 缓存过期时间（秒）
```

### 批量处理
```bash
VECTOR_BATCH_SIZE=32       # 向量化批处理大小
```

## 总结

智能搜索功能已经**完全实现并正常工作**，主要特点：

✅ **功能完整**: 前后端代码完整，API正常工作
✅ **检索准确**: 混合检索算法提供高准确度结果
✅ **性能良好**: 支持并行检索和缓存优化
✅ **易于使用**: 提供友好的Web界面和完整的API

**使用建议**:
1. 先创建足够数量的问答对（建议至少10个）
2. 确保问答对质量高且已验证
3. 使用具体的问题进行搜索
4. 根据搜索结果提供反馈，帮助系统学习

## 联系支持

如有问题或建议，请查看项目文档或提交Issue。
