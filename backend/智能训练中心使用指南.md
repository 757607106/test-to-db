# 智能训练中心 - 完整使用指南

## 功能概述

智能训练中心是一个完整的SQL问答对学习系统，包含以下核心功能：

1. **用户反馈机制**: 在聊天界面对AI回答进行点赞/点踩，点赞的高质量问答对自动存储
2. **智能搜索功能**: 基于混合检索（Hybrid Retrieval）的问答对搜索系统
3. **自动样本召回**: SQL生成时自动检索相似历史问答对，提升生成质量
4. **问答对管理**: 在管理后台查看、编辑、删除问答对

系统实现"越用越快、越用越准"的目标，通过用户反馈持续优化。

## 核心功能

### 1. 用户反馈机制（点赞/点踩）

**功能说明**:
- 在Chat聊天界面，AI回答包含SQL时，会显示👍和👎按钮
- **点赞(👍)**: 确认答案有帮助，问答对自动保存到智能训练中心
  - 标记为"已验证"，初始成功率100%
  - 用于后续相似问题的快速召回
- **点踩(👎)**: 反馈答案需要改进，记录用于系统优化

**使用步骤**:
1. 在聊天界面提问
2. 查看AI生成的SQL和结果
3. 点击👍如果答案准确，或点击👎如果需要改进
4. 系统自动处理反馈

**技术实现**:
- 前端自动提取用户问题和生成的SQL
- 调用 `/api/hybrid-qa/qa-pairs/from-feedback` 接口
- 点赞数据存储到Milvus向量库和Neo4j图数据库

### 2. 混合检索技术
结合多种检索方法，提供高准确度的搜索结果：
- **语义检索** (60%权重): 使用向量相似度匹配问题的语义含义
- **结构检索** (20%权重): 基于数据库schema和表结构匹配
- **模式检索** (10%权重): 识别SQL查询模式和类型
- **质量评分** (10%权重): 考虑问答对的验证状态和成功率

### 3. 自动样本召回
SQL生成时自动检索相似的历史问答对：
- 先快速检查是否有样本（毫秒级）
- 有样本则执行混合检索，参考历史案例生成SQL
- 无样本或检索失败则使用基础模式生成
- 可通过配置控制召回行为

### 2. 智能评分系统
每个搜索结果包含详细的评分信息：
- **final_score**: 综合得分（0-1之间）
- **semantic_score**: 语义相似度得分
- **structural_score**: 结构匹配得分
- **pattern_score**: 模式匹配得分
- **quality_score**: 质量评分
- **explanation**: 推荐理由说明

### 3. 多维度筛选
- 按数据库连接筛选
- 按查询类型分类（SELECT, JOIN, AGGREGATE, GROUP_BY, ORDER_BY）
- 按难度等级过滤（1-5级）
- 按验证状态筛选

## 使用方法

### 在后台管理界面使用

1. **访问智能训练中心**
   - 登录后台管理系统 (http://localhost:3001)
   - 点击左侧导航栏的"智能训练"
   - 进入"混合检索问答对管理"页面

2. **使用智能搜索**
   - 点击"智能搜索"标签页
   - 在搜索框中输入自然语言问题
   - 选择数据库连接（可选）
   - 设置返回结果数量（1-20，默认5）
   - 点击"搜索"按钮

3. **查看搜索结果**
   - 结果按相关度排序显示
   - 可以查看每个结果的详细信息
   - 可以对结果进行反馈

### 使用API调用

#### 搜索相似问答对

```bash
curl -X POST http://localhost:8000/api/hybrid-qa/qa-pairs/search \
  -H "Content-Type: application/json" \
  -d '{
    "question": "查询产品库存",
    "connection_id": 10,
    "top_k": 5
  }'
```

#### 响应示例

```json
[
  {
    "qa_pair": {
      "id": "qa_abc123",
      "question": "查询所有产品的库存数量",
      "sql": "SELECT product_name, stock_quantity FROM products",
      "connection_id": 10,
      "query_type": "SELECT",
      "difficulty_level": 1,
      "verified": true
    },
    "semantic_score": 0.85,
    "structural_score": 0.75,
    "pattern_score": 0.80,
    "quality_score": 0.90,
    "final_score": 0.82,
    "explanation": "高度语义匹配，已验证的高质量示例"
  }
]
```

## API端点

### 1. 搜索相似问答对
- **端点**: `POST /api/hybrid-qa/qa-pairs/search`
- **请求体**:
  ```json
  {
    "question": "string",           // 必填：自然语言问题
    "connection_id": 10,            // 可选：数据库连接ID
    "schema_context": {},           // 可选：schema上下文信息
    "top_k": 5                      // 可选：返回数量（默认5）
  }
  ```

### 2. 创建问答对
- **端点**: `POST /api/hybrid-qa/qa-pairs/`
- **请求体**:
  ```json
  {
    "question": "string",
    "sql": "string",
    "connection_id": 10,
    "query_type": "SELECT",
    "difficulty_level": 1,
    "verified": true
  }
  ```

### 3. 获取问答对列表
- **端点**: `GET /api/hybrid-qa/qa-pairs/`
- **参数**: `connection_id` (可选), `limit` (默认100)

### 4. 获取统计信息
- **端点**: `GET /api/hybrid-qa/qa-pairs/stats`
- **参数**: `connection_id` (可选)

### 5. 更新问答对
- **端点**: `PUT /api/hybrid-qa/qa-pairs/{qa_id}`

### 6. 删除问答对
- **端点**: `DELETE /api/hybrid-qa/qa-pairs/{qa_id}`

### 7. 提交反馈
- **端点**: `POST /api/hybrid-qa/qa-pairs/feedback`

## 测试验证

### 1. 用户反馈功能测试

```bash
# 1. 启动后端服务
cd backend && uvicorn app.main:app --reload

# 2. 启动前端聊天界面
cd frontend/chat && npm run dev

# 3. 访问 http://localhost:3000
# 4. 选择数据库连接，提问
# 5. 在AI回答中点击👍或👎按钮
# 6. 检查浏览器控制台和后端日志
```

**验证要点**:
- 点击👍后看到成功提示
- 后端日志显示"[Feedback-ThumbsUp] ✓ 问答对创建成功"
- 在管理后台能看到新创建的问答对

### 2. QA样本召回测试

使用测试脚本验证完整流程：

```bash
cd /Users/pusonglin/chat-to-db/backend
python3 test_feedback_and_retrieval.py
```

**测试内容**:
- ✅ 配置验证
- ✅ QA样本存在性检查
- ✅ 引擎池统计
- ✅ 创建QA对
- ✅ QA样本召回

### 3. 旧测试脚本（混合搜索）

```bash
python3 test_hybrid_search_with_data.py
```

**测试结果**（2026-01-18）：
- ✅ 创建了11个问答对
- ✅ 智能搜索功能正常
- ✅ 相关度评分准确
- ✅ 支持语义理解

示例搜索结果：
- "查询产品库存" → 匹配到"查询所有产品的库存数量" (得分: 0.560)
- "统计产品数量" → 匹配到"按类别统计产品数量" (得分: 0.593)
- "低库存警报" → 匹配到"查询低库存产品" (得分: 0.524)
- "供应商信息" → 匹配到"查询每个供应商提供的产品数量" (得分: 0.273)

## 配置说明

### 环境变量配置

在 `.env` 文件中配置：

```bash
# Milvus向量数据库
MILVUS_HOST=localhost
MILVUS_PORT=19530

# 向量服务配置
VECTOR_SERVICE_TYPE=aliyun          # 使用阿里云DashScope
DASHSCOPE_API_KEY=your_api_key     # DashScope API密钥
VECTOR_DIMENSION=1024               # 向量维度

# 混合检索配置
HYBRID_RETRIEVAL_ENABLED=true
SEMANTIC_WEIGHT=0.60               # 语义相似度权重
STRUCTURAL_WEIGHT=0.20             # 结构匹配权重
PATTERN_WEIGHT=0.10                # 模式匹配权重
QUALITY_WEIGHT=0.10                # 质量评分权重

# Neo4j图数据库（用于结构检索）
NEO4J_URI=bolt://localhost:7687
NEO4J_USER=neo4j
NEO4J_PASSWORD=your_password

# ==========================================
# QA样本智能召回配置（新增）
# ==========================================
# 是否启用QA样本召回
QA_SAMPLE_ENABLED=true

# 最小相似度阈值（0.0-1.0）
# 建议值：0.6-0.7，值越高质量越高但召回率越低
QA_SAMPLE_MIN_SIMILARITY=0.6

# 召回的样本数量
# 建议值：3-5，过多可能导致prompt过长
QA_SAMPLE_TOP_K=3

# 检索超时时间（秒）
# 建议值：5-15秒
QA_SAMPLE_TIMEOUT=10

# 快速降级（检索失败时快速跳过）
QA_SAMPLE_FAST_FALLBACK=true

# 只使用验证过的样本
QA_SAMPLE_VERIFIED_ONLY=false

# 最低成功率阈值（0.0-1.0）
QA_SAMPLE_MIN_SUCCESS_RATE=0.7
```

### 前端配置

在 `frontend/chat/.env.local` 中配置：

```bash
# Admin API地址（用于提交反馈）
NEXT_PUBLIC_ADMIN_API_URL=http://localhost:8000/api
```

### 服务依赖

系统依赖以下服务正常运行：

1. **Milvus** (端口 19530)
   - 向量数据库，用于语义检索
   
2. **Neo4j** (端口 7687)
   - 图数据库，用于结构和模式检索
   
3. **阿里云DashScope**
   - 文本向量化服务

## 技术架构

### 核心组件

1. **HybridRetrievalEngine** (`hybrid_retrieval_service.py`)
   - 混合检索引擎主类
   - 协调多种检索方法
   - 融合和排序结果

2. **MilvusService**
   - 向量数据库服务
   - 存储和检索问答对向量

3. **Neo4jService**
   - 图数据库服务
   - 存储schema和关系信息

4. **FusionRanker**
   - 结果融合和排序
   - 加权评分计算

### 数据流程

```
用户问题
  ↓
[语义向量化]
  ↓
[并行检索]
  ├─ 语义检索 (Milvus)
  ├─ 结构检索 (Neo4j)
  └─ 模式检索 (规则)
  ↓
[融合排序]
  ↓
[返回Top-K结果]
```

## 最佳实践

### 1. 创建高质量问答对
- 使用清晰、具体的自然语言问题
- 确保SQL语句正确可执行
- 标记已验证的问答对
- 设置合适的难度等级

### 2. 优化搜索结果
- 提供完整的schema上下文
- 使用具体的数据库连接ID
- 适当调整top_k参数
- 对搜索结果提供反馈

### 3. 维护问答对库
- 定期验证问答对的正确性
- 删除过时或错误的问答对
- 添加多样化的查询示例
- 覆盖不同难度级别和查询类型

## 问题排查

### 搜索结果为空

**可能原因**:
1. 问答对库为空或数据太少
2. connection_id筛选过严格
3. 向量服务未正常工作

**解决方法**:
1. 检查问答对数量: `GET /api/hybrid-qa/qa-pairs/stats`
2. 尝试不指定connection_id
3. 查看服务日志检查向量化是否成功

### 搜索结果相关度低

**可能原因**:
1. 问答对质量不高
2. 问题描述不够具体
3. schema上下文不完整

**解决方法**:
1. 添加更多高质量的问答对
2. 使用更具体的问题描述
3. 提供完整的schema_context

### 服务启动失败

**可能原因**:
1. Milvus或Neo4j未启动
2. 网络配置问题
3. API密钥配置错误

**解决方法**:
1. 检查依赖服务状态
2. 验证.env配置
3. 查看服务启动日志

## 性能优化

### 并行检索
```bash
PARALLEL_RETRIEVAL=true  # 启用并行检索，提升速度
```

### 向量缓存
```bash
VECTOR_CACHE_ENABLED=true  # 启用向量缓存
VECTOR_CACHE_TTL=3600      # 缓存过期时间（秒）
```

### 批量处理
```bash
VECTOR_BATCH_SIZE=32       # 向量化批处理大小
```

## 日志和监控

### 查看日志

系统在关键路径添加了详细的日志：

**反馈相关日志**:
```
[Feedback] 收到用户反馈 - 类型: thumbs_up, 连接ID: 15
[Feedback-ThumbsUp] 开始创建问答对...
[Feedback-ThumbsUp] ✓ 问答对创建成功 - ID: qa_xxx, 耗时: 0.45s
```

**样本召回日志**:
```
[QuickRetrieve] 开始检索QA样本 - 连接ID: 15, 查询: '查询库存少的产品'
[QuickRetrieve] 样本存在检查通过，耗时: 0.023s
[QuickRetrieve] ✓ 检索完成 - 找到: 2/3个高质量样本, 总耗时: 0.156s
```

### 性能监控指标

关键性能指标：
- **反馈处理时间**: 通常< 1秒
- **样本检索时间**: 通常< 200ms
- **样本存在性检查**: 通常< 50ms
- **混合检索时间**: 通常< 150ms

## 最佳实践

### 1. 积累高质量问答对

**建议**:
- 在使用过程中对准确的回答点赞
- 定期审查管理后台的问答对
- 验证重要的问答对，提高其权重
- 删除过时或错误的问答对

**质量标准**:
- 问题表述清晰具体
- SQL语法正确且可执行
- 覆盖不同难度和查询类型
- 包含常见业务场景

### 2. 优化配置参数

**相似度阈值调整**:
- 样本质量高：降低阈值（0.5-0.6）提高召回率
- 样本质量低：提高阈值（0.7-0.8）保证精确度

**样本数量调整**:
- 简单查询：1-2个样本
- 复杂查询：3-5个样本
- 避免过多样本导致prompt过长

**超时时间设置**:
- 网络良好：5-10秒
- 网络一般：10-15秒
- 启用快速降级避免影响用户体验

### 3. 监控系统效果

**关键指标**:
- 点赞率：用户满意度指标
- 召回命中率：样本库覆盖度
- 生成准确率：使用样本后的准确率提升
- 响应时间：整体性能指标

## 常见问题补充

### Q4: 点赞后在哪里查看问答对？

**答案**:
1. 访问管理后台 `http://localhost:3001`
2. 进入"智能训练"或"Hybrid QA"页面
3. 选择对应的数据库连接进行筛选
4. 查看问答对列表和统计信息

### Q5: 如何关闭样本召回功能？

**答案**:
在 `.env` 中设置：
```bash
QA_SAMPLE_ENABLED=false
```
重启后端服务生效。关闭后SQL生成将不使用历史样本。

### Q6: 样本召回是否会影响响应速度？

**答案**:
- 有样本时增加约100-200ms延迟
- 无样本时仅增加约20-50ms（快速检查）
- 检索失败时快速降级，不影响正常流程
- 可通过 `QA_SAMPLE_TIMEOUT` 控制最大等待时间

### Q7: 前端点赞按钮不显示？

**排查步骤**:
1. 检查AI回答中是否包含SQL代码块
2. 检查浏览器控制台是否有错误
3. 确认 `NEXT_PUBLIC_ADMIN_API_URL` 配置正确
4. 查看 `feedback-service.ts` 的SQL提取日志

## 总结

智能训练中心已经**完全实现并正常工作**，主要特点：

✅ **用户反馈**: 点赞/点踩机制完整，自动存储高质量问答对
✅ **智能召回**: SQL生成时自动检索相似样本，提升准确率
✅ **灵活配置**: 丰富的配置选项，适应不同场景需求
✅ **性能优化**: 快速检查、并行检索、缓存优化
✅ **日志完善**: 详细的日志记录，便于监控和调试
✅ **易于管理**: 友好的Web界面和完整的API

**系统优势**:
- 🚀 越用越快：样本库越丰富，召回越精准
- 🎯 越用越准：用户反馈持续优化样本质量
- 🔄 自动学习：点赞数据自动转化为训练样本
- ⚡ 性能保障：快速降级机制确保用户体验

**下一步建议**:
1. 持续收集用户反馈，丰富样本库
2. 定期分析点踩数据，识别系统短板
3. 根据监控指标调整配置参数
4. 考虑实现样本去重和质量评估

## 联系支持

如有问题或建议，请查看项目文档或提交Issue。

**相关文档**:
- [配置示例](../backend/.env.example.qa_config)
- [测试脚本](../backend/test_feedback_and_retrieval.py)
- [项目架构](../docs/PROJECT_STRUCTURE.md)
