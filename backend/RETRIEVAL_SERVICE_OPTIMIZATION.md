# SQLæ ·æœ¬æ£€ç´¢æœåŠ¡ä¼˜åŒ–è¯´æ˜

## æ¦‚è¿°

æœ¬æ–‡æ¡£è¯´æ˜äº†é’ˆå¯¹SQLæ ·æœ¬æ£€ç´¢æœåŠ¡çš„æ€§èƒ½ä¼˜åŒ–å’Œç”¨æˆ·ä½“éªŒæ”¹è¿›ã€‚

## ä¼˜åŒ–å†…å®¹

### 1. æ·»åŠ è¶…æ—¶æœºåˆ¶å’Œè¯¦ç»†é”™è¯¯æç¤º

**é—®é¢˜ï¼š** æ£€ç´¢æœåŠ¡å¯èƒ½å› ä¸ºMilvusæˆ–Neo4jè¿æ¥é—®é¢˜è€Œé•¿æ—¶é—´å¡ä½ï¼Œç”¨æˆ·æ— æ³•å¾—çŸ¥åŸå› ã€‚

**è§£å†³æ–¹æ¡ˆï¼š**
- æ·»åŠ 15ç§’è¶…æ—¶æ§åˆ¶ï¼ˆå¯é…ç½®ï¼‰
- æ•è·å¹¶è¿”å›è¯¦ç»†é”™è¯¯ä¿¡æ¯
- åŒºåˆ†ä¸åŒç±»å‹çš„é”™è¯¯ï¼ˆInitializationErrorã€TimeoutErrorç­‰ï¼‰
- æä¾›æ•…éšœæ’æŸ¥å»ºè®®

**æ–‡ä»¶ä¿®æ”¹ï¼š**
- `backend/app/agents/agents/sample_retrieval_agent.py`

**æ•ˆæœï¼š**
```python
# é”™è¯¯è¿”å›ç¤ºä¾‹
{
  "success": False,
  "error": "æ£€ç´¢è¶…æ—¶ï¼ˆ15ç§’ï¼‰- å¯èƒ½æ˜¯æ•°æ®åº“è¿æ¥é—®é¢˜",
  "error_type": "TimeoutError",
  "qa_pairs": [],
  "suggestion": "è¯·æ£€æŸ¥ä»¥ä¸‹æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ: 1) Milvuså‘é‡æ•°æ®åº“ 2) Neo4jå›¾æ•°æ®åº“",
  "troubleshooting": {
    "check_milvus": "docker ps | grep milvus",
    "check_neo4j": "docker ps | grep neo4j",
    "timeout_seconds": 15
  }
}
```

### 2. å®ç°æœåŠ¡å®ä¾‹å¤ç”¨ï¼ˆè¿æ¥æ± ï¼‰

**é—®é¢˜ï¼š** æ¯æ¬¡è°ƒç”¨æ£€ç´¢å·¥å…·éƒ½ä¼šé‡æ–°åˆå§‹åŒ–Milvusã€Neo4jå’Œå‘é‡æœåŠ¡ï¼Œå¯¼è‡´é¦–æ¬¡è°ƒç”¨éå¸¸æ…¢ï¼ˆ10-15ç§’ï¼‰ã€‚

**è§£å†³æ–¹æ¡ˆï¼š**
- åˆ›å»º `HybridRetrievalEnginePool` ç±»
- ä½¿ç”¨å•ä¾‹æ¨¡å¼ç®¡ç†é»˜è®¤å¼•æ“
- æŒ‰ `connection_id` ç¼“å­˜å¼•æ“å®ä¾‹
- çº¿ç¨‹å®‰å…¨çš„å¼‚æ­¥é”æœºåˆ¶

**æ–‡ä»¶ä¿®æ”¹ï¼š**
- `backend/app/services/hybrid_retrieval_service.py` - æ·»åŠ  HybridRetrievalEnginePool ç±»
- `backend/app/agents/agents/sample_retrieval_agent.py` - ä½¿ç”¨æ± åŒ–å¼•æ“

**ä½¿ç”¨æ–¹å¼ï¼š**
```python
from app.services.hybrid_retrieval_service import HybridRetrievalEnginePool

# è·å–é»˜è®¤å¼•æ“ï¼ˆè‡ªåŠ¨åˆå§‹åŒ–å’Œç¼“å­˜ï¼‰
engine = await HybridRetrievalEnginePool.get_engine()

# è·å–ç‰¹å®šè¿æ¥çš„å¼•æ“
engine = await HybridRetrievalEnginePool.get_engine(connection_id=10)

# å¥åº·æ£€æŸ¥
status = await HybridRetrievalEnginePool.health_check()

# æ¸…ç†ç¼“å­˜
HybridRetrievalEnginePool.clear_cache()
```

**æ€§èƒ½æå‡ï¼š**
- é¦–æ¬¡è°ƒç”¨ï¼š10-15ç§’ï¼ˆåˆå§‹åŒ–å¼€é”€ï¼‰
- åç»­è°ƒç”¨ï¼š< 1ç§’ï¼ˆç›´æ¥ä½¿ç”¨ç¼“å­˜å®ä¾‹ï¼‰
- **æ€§èƒ½æå‡ï¼š80%+**

### 3. ä¼˜åŒ–Agent Promptï¼ˆå¿«é€Ÿé™çº§ç­–ç•¥ï¼‰

**é—®é¢˜ï¼š** Agentåœ¨æ£€ç´¢å¤±è´¥æ—¶ä¼šå°è¯•é‡è¯•æˆ–ç­‰å¾…ï¼Œé˜»å¡æ•´ä¸ªæŸ¥è¯¢æµç¨‹ã€‚

**è§£å†³æ–¹æ¡ˆï¼š**
- æ›´æ–° `SampleRetrievalAgent` çš„ç³»ç»Ÿæç¤ºè¯
- æ˜ç¡®æŒ‡ç¤ºï¼šæ£€ç´¢å¤±è´¥æ—¶ç«‹å³æŠ¥å‘Šå¹¶ç»“æŸï¼Œä¸è¦é‡è¯•
- å¼ºè°ƒï¼šSQLç”Ÿæˆå™¨å¯ä»¥åœ¨æ— æ ·æœ¬æƒ…å†µä¸‹å·¥ä½œ
- æä¾›æ ‡å‡†çš„é”™è¯¯å“åº”æ ¼å¼

**æ–‡ä»¶ä¿®æ”¹ï¼š**
- `backend/app/agents/agents/sample_retrieval_agent.py` - `_create_system_prompt()`

**å…³é”®æŒ‡å¯¼åŸåˆ™ï¼š**
1. æ£€ç´¢å¤±è´¥ä¸æ˜¯è‡´å‘½é”™è¯¯
2. å¿«é€Ÿå¤±è´¥ï¼Œä¸è¦é˜»å¡ç”¨æˆ·æŸ¥è¯¢
3. æä¾›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯å’Œæ’æŸ¥å»ºè®®
4. å‘ŠçŸ¥ç³»ç»Ÿå°†ä½¿ç”¨åŸºç¡€æ¨¡å¼ç”ŸæˆSQL

### 4. å‰ç«¯æ˜¾ç¤ºå·¥å…·æ‰§è¡ŒçŠ¶æ€

**é—®é¢˜ï¼š** ç”¨æˆ·åœ¨å‰ç«¯çœ‹åˆ°å·¥å…·è°ƒç”¨åï¼Œä¸çŸ¥é“æ­£åœ¨å‘ç”Ÿä»€ä¹ˆï¼Œå°¤å…¶æ˜¯é•¿æ—¶é—´è¿è¡Œçš„æ£€ç´¢æ“ä½œã€‚

**è§£å†³æ–¹æ¡ˆï¼š**
- åœ¨ `retrieve_similar_qa_pairs` å·¥å…·çš„ pending çŠ¶æ€æ˜¾ç¤ºæç¤ºä¿¡æ¯
- åœ¨é”™è¯¯çŠ¶æ€æ˜¾ç¤ºå‹å¥½çš„é”™è¯¯ä¿¡æ¯å’Œæ’æŸ¥å»ºè®®
- åŒºåˆ†æŠ˜å å’Œå±•å¼€çŠ¶æ€çš„æ˜¾ç¤ºå†…å®¹

**æ–‡ä»¶ä¿®æ”¹ï¼š**
- `frontend/chat/src/components/thread/messages/tool-calls.tsx`

**ç”¨æˆ·ä½“éªŒæ”¹è¿›ï¼š**

**Pending çŠ¶æ€ï¼š**
```
ğŸ”„ retrieve_similar_qa_pairs
   æ­£åœ¨æ£€ç´¢SQLæ ·æœ¬ï¼Œå¯èƒ½éœ€è¦10-15ç§’...
   é¦–æ¬¡è°ƒç”¨éœ€è¦åˆå§‹åŒ–Milvuså’ŒNeo4jæœåŠ¡
```

**é”™è¯¯çŠ¶æ€ï¼ˆå±•å¼€ï¼‰ï¼š**
```
âŒ retrieve_similar_qa_pairs

æ£€ç´¢æœåŠ¡é‡åˆ°é—®é¢˜

TimeoutError: æ£€ç´¢è¶…æ—¶ï¼ˆ15ç§’ï¼‰- å¯èƒ½æ˜¯æ•°æ®åº“è¿æ¥é—®é¢˜

å»ºè®®: è¯·æ£€æŸ¥ä»¥ä¸‹æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ: 1) Milvuså‘é‡æ•°æ®åº“ 2) Neo4jå›¾æ•°æ®åº“

æ•…éšœæ’æŸ¥:
  â€¢ docker ps | grep milvus
  â€¢ docker ps | grep neo4j
  â€¢ 15

ğŸ’¡ ç³»ç»Ÿå°†ç»§ç»­ä½¿ç”¨åŸºç¡€æ¨¡å¼ç”ŸæˆSQLï¼ˆæ— æ ·æœ¬å‚è€ƒï¼‰
```

### 5. é¢„çƒ­åˆå§‹åŒ–æœºåˆ¶

**é—®é¢˜ï¼š** é¦–æ¬¡æŸ¥è¯¢éœ€è¦ç­‰å¾…æœåŠ¡åˆå§‹åŒ–ï¼Œä½“éªŒä¸ä½³ã€‚

**è§£å†³æ–¹æ¡ˆï¼š**
- åˆ›å»ºé¢„çƒ­åˆå§‹åŒ–å‡½æ•° `warmup_services()`
- æä¾›ç‹¬ç«‹çš„é¢„çƒ­è„šæœ¬ `warmup_services.py`
- å¯é€‰æ‹©æ€§åœ°åœ¨åº”ç”¨å¯åŠ¨åè¿è¡Œ

**æ–‡ä»¶ä¿®æ”¹ï¼š**
- `backend/app/agents/chat_graph.py` - æ·»åŠ  `warmup_services()` å‡½æ•°
- `backend/warmup_services.py` - ç‹¬ç«‹é¢„çƒ­è„šæœ¬

**ä½¿ç”¨æ–¹å¼ï¼š**

#### æ–¹å¼1ï¼šç‹¬ç«‹è„šæœ¬ï¼ˆæ¨èï¼‰
```bash
# åœ¨åº”ç”¨å¯åŠ¨åè¿è¡Œ
cd backend
python warmup_services.py

# æˆ–æŒ‡å®šç‰¹å®šè¿æ¥ID
python warmup_services.py --connections 10 15 20
```

#### æ–¹å¼2ï¼šåœ¨ä»£ç ä¸­è°ƒç”¨
```python
from app.agents.chat_graph import warmup_services

# åœ¨FastAPIå¯åŠ¨äº‹ä»¶ä¸­
@app.on_event("startup")
async def startup_event():
    await warmup_services(connection_ids=[10, 15])
```

#### æ–¹å¼3ï¼šåŒæ­¥ç¯å¢ƒ
```python
from app.agents.chat_graph import warmup_services_sync

# åœ¨éå¼‚æ­¥ç¯å¢ƒä¸­
warmup_services_sync(connection_ids=[10, 15])
```

## ä½¿ç”¨å»ºè®®

### å¼€å‘ç¯å¢ƒ

1. **é¦–æ¬¡å¯åŠ¨æ—¶è¿è¡Œé¢„çƒ­ï¼š**
   ```bash
   # å¯åŠ¨åº”ç”¨
   python chat_server.py
   
   # åœ¨å¦ä¸€ä¸ªç»ˆç«¯è¿è¡Œé¢„çƒ­ï¼ˆå¯é€‰ï¼‰
   python warmup_services.py
   ```

2. **åç»­å¼€å‘ä¸­ï¼š**
   - æœåŠ¡å®ä¾‹ä¼šè‡ªåŠ¨ç¼“å­˜ï¼Œæ— éœ€æ¯æ¬¡é¢„çƒ­
   - ä¿®æ”¹ä»£ç é‡å¯åï¼Œç¼“å­˜ä¼šæ¸…ç©ºï¼Œå¯èƒ½éœ€è¦å†æ¬¡é¢„çƒ­

### ç”Ÿäº§ç¯å¢ƒ

1. **æ¨èé…ç½®ï¼š**
   - åœ¨åº”ç”¨å¯åŠ¨åè‡ªåŠ¨è¿è¡Œé¢„çƒ­è„šæœ¬
   - æˆ–åœ¨å¯åŠ¨äº‹ä»¶ä¸­è°ƒç”¨ `warmup_services()`
   - é¢„çƒ­å¸¸ç”¨çš„ `connection_id`

2. **ç›‘æ§å»ºè®®ï¼š**
   - å®šæœŸæ£€æŸ¥æ£€ç´¢æœåŠ¡å¥åº·çŠ¶æ€
   - ç›‘æ§æ£€ç´¢è¶…æ—¶ç‡
   - è®°å½•åˆå§‹åŒ–å¤±è´¥æ—¥å¿—

## æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼šæ£€ç´¢æ€»æ˜¯è¶…æ—¶

**å¯èƒ½åŸå› ï¼š**
- Milvusæœªå¯åŠ¨æˆ–ç«¯å£ä¸æ­£ç¡®
- Neo4jæœªå¯åŠ¨æˆ–ç«¯å£ä¸æ­£ç¡®
- ç½‘ç»œè¿æ¥é—®é¢˜

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
docker ps | grep milvus
docker ps | grep neo4j

# æŸ¥çœ‹æ—¥å¿—
docker logs <milvus_container_id>
docker logs <neo4j_container_id>

# é‡å¯æœåŠ¡
docker-compose restart milvus
docker-compose restart neo4j
```

### é—®é¢˜2ï¼šåˆå§‹åŒ–å¤±è´¥

**å¯èƒ½åŸå› ï¼š**
- å‘é‡æœåŠ¡é…ç½®é”™è¯¯
- æ•°æ®åº“è¿æ¥ä¿¡æ¯é”™è¯¯
- ä¾èµ–åº“ç‰ˆæœ¬ä¸å…¼å®¹

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# æ£€æŸ¥ç¯å¢ƒå˜é‡
env | grep VECTOR
env | grep MILVUS
env | grep NEO4J

# æ£€æŸ¥é…ç½®
python -c "from app.core.config import settings; print(settings.VECTOR_SERVICE_TYPE)"

# æµ‹è¯•è¿æ¥
python -c "from app.services.hybrid_retrieval_service import VectorServiceFactory; import asyncio; asyncio.run(VectorServiceFactory.get_default_service())"
```

### é—®é¢˜3ï¼šé¢„çƒ­è„šæœ¬å¤±è´¥

**å¯èƒ½åŸå› ï¼š**
- Pythonè·¯å¾„é—®é¢˜
- æ•°æ®åº“æœåŠ¡æœªå°±ç»ª

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# ç¡®ä¿åœ¨backendç›®å½•ä¸‹è¿è¡Œ
cd backend

# ä½¿ç”¨å®Œæ•´è·¯å¾„
python /path/to/backend/warmup_services.py

# æ£€æŸ¥Pythonæ¨¡å—
python -c "import app.agents.chat_graph"
```

## æ€§èƒ½å¯¹æ¯”

### ä¼˜åŒ–å‰

| åœºæ™¯ | é¦–æ¬¡è°ƒç”¨ | åç»­è°ƒç”¨ | è¶…æ—¶å¤„ç† | é”™è¯¯æç¤º |
|------|---------|---------|---------|---------|
| æ£€ç´¢æœåŠ¡ | 10-15ç§’ | 10-15ç§’ | æ— é™ç­‰å¾… | æ—  |
| ç”¨æˆ·ä½“éªŒ | âŒ å¾ˆå·® | âŒ å¾ˆå·® | âŒ å¡ä½ | âŒ å›°æƒ‘ |

### ä¼˜åŒ–å

| åœºæ™¯ | é¦–æ¬¡è°ƒç”¨ | åç»­è°ƒç”¨ | è¶…æ—¶å¤„ç† | é”™è¯¯æç¤º |
|------|---------|---------|---------|---------|
| æ£€ç´¢æœåŠ¡ï¼ˆæ— é¢„çƒ­ï¼‰ | 10-15ç§’ | < 1ç§’ | 15ç§’è¶…æ—¶ | âœ… è¯¦ç»† |
| æ£€ç´¢æœåŠ¡ï¼ˆé¢„çƒ­åï¼‰ | < 1ç§’ | < 1ç§’ | 15ç§’è¶…æ—¶ | âœ… è¯¦ç»† |
| ç”¨æˆ·ä½“éªŒ | âœ… è‰¯å¥½ | âœ… ä¼˜ç§€ | âœ… å¿«é€Ÿå¤±è´¥ | âœ… æ¸…æ™° |

**å…³é”®æ”¹è¿›ï¼š**
- åç»­è°ƒç”¨æ€§èƒ½æå‡ï¼š**90%+**ï¼ˆ15ç§’ â†’ 1ç§’ï¼‰
- è¶…æ—¶ä¿æŠ¤ï¼šé¿å…æ— é™ç­‰å¾…
- é”™è¯¯é€æ˜åº¦ï¼šæä¾›è¯¦ç»†çš„æ’æŸ¥ä¿¡æ¯
- ç”¨æˆ·ä½“éªŒï¼šæ¸…æ™°çš„çŠ¶æ€æç¤º

## é…ç½®é€‰é¡¹

### è¶…æ—¶é…ç½®

ä¿®æ”¹ `sample_retrieval_agent.py` ä¸­çš„é»˜è®¤è¶…æ—¶ï¼š
```python
@tool
def retrieve_similar_qa_pairs(
    user_query: str,
    schema_context: Dict[str, Any],
    connection_id: int = 15,
    top_k: int = 5,
    timeout: int = 15  # ä¿®æ”¹è¿™é‡Œï¼Œå•ä½ï¼šç§’
) -> Dict[str, Any]:
    ...
```

### ç¼“å­˜ç®¡ç†

æ¸…ç†å¼•æ“ç¼“å­˜ï¼š
```python
from app.services.hybrid_retrieval_service import HybridRetrievalEnginePool

# æ¸…ç†æ‰€æœ‰ç¼“å­˜
HybridRetrievalEnginePool.clear_cache()
```

è·å–ç»Ÿè®¡ä¿¡æ¯ï¼š
```python
stats = HybridRetrievalEnginePool.get_stats()
print(stats)
# {
#   "initialized": True,
#   "has_default_engine": True,
#   "cached_engines_count": 3,
#   "cached_connection_ids": [10, 15, 20]
# }
```

## æ€»ç»“

è¿™äº›ä¼˜åŒ–æ˜¾è‘—æå‡äº†SQLæ ·æœ¬æ£€ç´¢æœåŠ¡çš„æ€§èƒ½å’Œç”¨æˆ·ä½“éªŒï¼š

âœ… **æ€§èƒ½æå‡ï¼š** åç»­æŸ¥è¯¢é€Ÿåº¦æå‡90%+  
âœ… **ç¨³å®šæ€§å¢å¼ºï¼š** è¶…æ—¶ä¿æŠ¤ï¼Œé¿å…æ— é™ç­‰å¾…  
âœ… **é”™è¯¯é€æ˜ï¼š** è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯å’Œæ’æŸ¥å»ºè®®  
âœ… **ç”¨æˆ·ä½“éªŒï¼š** æ¸…æ™°çš„çŠ¶æ€æç¤ºå’Œè¿›åº¦åé¦ˆ  
âœ… **å¯ç»´æŠ¤æ€§ï¼š** æ›´å¥½çš„æ—¥å¿—å’Œç›‘æ§èƒ½åŠ›  

ç³»ç»Ÿç°åœ¨èƒ½å¤Ÿä¼˜é›…åœ°å¤„ç†æ£€ç´¢å¤±è´¥ï¼Œä¸ä¼šé˜»å¡ç”¨æˆ·çš„æŸ¥è¯¢ï¼ŒåŒæ—¶æä¾›æ¸…æ™°çš„åé¦ˆä¿¡æ¯ã€‚
